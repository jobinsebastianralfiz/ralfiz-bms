{% extends 'base.html' %}
{% load static %}

{% block title %}Payments - Ralfiz BMS{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard' %}" class="breadcrumb-item">Dashboard</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">Payments</span>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Payments</h1>
    <p class="page-subtitle mb-0">Track all payment transactions</p>
  </div>
  <div class="page-actions">
    <a href="{% url 'payment_create' %}" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      Record Payment
    </a>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon success">
          <i class="fas fa-rupee-sign"></i>
        </div>
      </div>
      <div class="stat-card-value">&#8377;{{ total_received|floatformat:0|default:"0" }}</div>
      <div class="stat-card-label">Total Received (This Year)</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon primary">
          <i class="fas fa-calendar-alt"></i>
        </div>
      </div>
      <div class="stat-card-value">&#8377;{{ this_month|floatformat:0|default:"0" }}</div>
      <div class="stat-card-label">This Month</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon info">
          <i class="fas fa-exchange-alt"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ total_transactions|default:"0" }}</div>
      <div class="stat-card-label">Total Transactions</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon warning">
          <i class="fas fa-hourglass-half"></i>
        </div>
      </div>
      <div class="stat-card-value">&#8377;{{ outstanding|floatformat:0|default:"0" }}</div>
      <div class="stat-card-label">Outstanding</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row align-items-end">
      <div class="col-3 col-md-6 col-sm-12" style="padding: 0.5rem;">
        <div class="form-group mb-0">
          <label class="form-label">Search</label>
          <input type="text" class="form-control" name="search" placeholder="Search by invoice, client..." value="{{ search }}">
        </div>
      </div>
      <div class="col-3 col-md-6 col-sm-12" style="padding: 0.5rem;">
        <div class="form-group mb-0">
          <label class="form-label">Client</label>
          <select class="form-control" name="client">
            <option value="">All Clients</option>
            {% for c in clients %}
            <option value="{{ c.pk }}" {% if client == c.pk|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-3 col-md-6 col-sm-12" style="padding: 0.5rem;">
        <div class="form-group mb-0">
          <label class="form-label">Payment Method</label>
          <select class="form-control" name="method">
            <option value="">All Methods</option>
            {% for key, value in method_choices %}
            <option value="{{ key }}" {% if method == key %}selected{% endif %}>{{ value }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-3 col-md-6 col-sm-12" style="padding: 0.5rem;">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-filter me-2"></i>Apply Filters
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Payments Table -->
<div class="card">
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Client</th>
          <th>Invoice</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Transaction ID</th>
          <th>Recorded By</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in payments %}
        <tr>
          <td class="fw-medium">{{ payment.payment_date|date:"d M Y" }}</td>
          <td>
            <a href="{% url 'client_detail' payment.invoice.client.pk %}">{{ payment.invoice.client.name }}</a>
          </td>
          <td>
            <a href="{% url 'invoice_detail' payment.invoice.pk %}">{{ payment.invoice.invoice_number }}</a>
          </td>
          <td class="fw-medium text-success">&#8377;{{ payment.amount|floatformat:0 }}</td>
          <td>
            <span class="badge {% if payment.payment_method == 'bank_transfer' %}badge-info{% elif payment.payment_method == 'upi' %}badge-success{% elif payment.payment_method == 'cheque' %}badge-warning{% else %}badge-secondary{% endif %}">
              {{ payment.get_payment_method_display }}
            </span>
          </td>
          <td class="text-muted">
            {% if payment.transaction_id %}
            <code>{{ payment.transaction_id }}</code>
            {% else %}
            -
            {% endif %}
          </td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="avatar avatar-sm">{{ payment.recorded_by.first_name|slice:":1"|upper }}{{ payment.recorded_by.last_name|slice:":1"|upper|default:"U" }}</div>
              <span>{{ payment.recorded_by.get_full_name|default:payment.recorded_by.username }}</span>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center py-4 text-muted">No payments found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
