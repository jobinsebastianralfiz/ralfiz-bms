{% extends 'base.html' %}
{% load static %}

{% block title %}{{ credential.name }} - Ralfiz BMS{% endblock %}

{% block extra_css %}
<style>
  .avatar-xl {
    width: 64px;
    height: 64px;
    font-size: 1.5rem;
  }
  .password-field {
    font-family: monospace;
    letter-spacing: 2px;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard' %}" class="breadcrumb-item">Dashboard</a>
<span class="breadcrumb-separator">/</span>
<a href="{% url 'credential_list' %}" class="breadcrumb-item">Credentials</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">{{ credential.name }}</span>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="d-flex align-items-center gap-4">
    <div class="avatar avatar-xl" style="background: var(--secondary-light); color: var(--secondary);">
      {% if credential.credential_type == 'server' %}
      <i class="fas fa-server"></i>
      {% elif credential.credential_type == 'database' %}
      <i class="fas fa-database"></i>
      {% elif credential.credential_type == 'hosting' %}
      <i class="fas fa-cloud"></i>
      {% elif credential.credential_type == 'domain' %}
      <i class="fas fa-globe"></i>
      {% elif credential.credential_type == 'email' %}
      <i class="fas fa-envelope"></i>
      {% elif credential.credential_type == 'ssl' %}
      <i class="fas fa-shield-alt"></i>
      {% elif credential.credential_type == 'api' %}
      <i class="fas fa-plug"></i>
      {% else %}
      <i class="fas fa-key"></i>
      {% endif %}
    </div>
    <div>
      <div class="d-flex align-items-center gap-3 mb-2">
        <h1 class="page-title mb-0">{{ credential.name }}</h1>
        {% if credential.is_expired %}
        <span class="status-badge danger">Expired</span>
        {% elif credential.is_expiring_soon %}
        <span class="status-badge warning">Expiring Soon</span>
        {% else %}
        <span class="status-badge success">Active</span>
        {% endif %}
        <span class="badge badge-secondary">{{ credential.get_credential_type_display }}</span>
      </div>
      <p class="page-subtitle mb-0">
        <a href="{% url 'project_detail' credential.project.pk %}" class="text-primary">
          <i class="fas fa-folder me-1"></i>{{ credential.project.name }}
        </a>
        <span class="mx-2">|</span>
        <a href="{% url 'client_detail' credential.project.client.pk %}">
          <i class="fas fa-building me-1"></i>{{ credential.project.client.name }}
        </a>
      </p>
    </div>
  </div>
  <div class="page-actions">
    <a href="{% url 'credential_update' credential.pk %}" class="btn btn-primary">
      <i class="fas fa-edit"></i>
      Edit Credential
    </a>
    <a href="{% url 'credential_delete' credential.pk %}" class="btn btn-danger">
      <i class="fas fa-trash-alt"></i>
      Delete
    </a>
  </div>
</div>

<!-- Main Content Grid -->
<div class="row">
  <!-- Left Column -->
  <div class="col-6 col-md-12" style="padding: 0.75rem;">
    <!-- Login Details -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-lock me-2"></i>Login Details
        </h3>
      </div>
      <div class="card-body">
        {% if credential.url %}
        <div class="mb-4">
          <div class="text-sm text-muted mb-1">Login URL / IP Address</div>
          <div class="d-flex align-items-center gap-2">
            <code class="bg-light px-3 py-2 rounded" style="font-size: 0.9rem;">{{ credential.url }}</code>
            <button class="btn btn-sm btn-ghost btn-icon" onclick="copyToClipboard('{{ credential.url }}')" title="Copy">
              <i class="fas fa-copy"></i>
            </button>
            <a href="{{ credential.url }}" class="btn btn-sm btn-ghost btn-icon" title="Open Link" target="_blank">
              <i class="fas fa-external-link-alt"></i>
            </a>
          </div>
        </div>
        {% endif %}

        {% if credential.username %}
        <div class="mb-4">
          <div class="text-sm text-muted mb-1">Username</div>
          <div class="d-flex align-items-center gap-2">
            <code class="bg-light px-3 py-2 rounded" style="font-size: 0.9rem;">{{ credential.username }}</code>
            <button class="btn btn-sm btn-ghost btn-icon" onclick="copyToClipboard('{{ credential.username }}')" title="Copy">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        {% endif %}

        {% if credential.password %}
        <div class="mb-4">
          <div class="text-sm text-muted mb-1">Password</div>
          <div class="d-flex align-items-center gap-2">
            <code class="bg-light px-3 py-2 rounded password-field" style="font-size: 0.9rem;" id="passwordDisplay">
              ••••••••••••••••
            </code>
            <button class="btn btn-sm btn-ghost btn-icon" onclick="togglePasswordVisibility()" title="Show/Hide">
              <i class="fas fa-eye" id="toggleIcon"></i>
            </button>
            <button class="btn btn-sm btn-ghost btn-icon" onclick="copyPassword()" title="Copy Password">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        {% endif %}

        {% if credential.port %}
        <div>
          <div class="text-sm text-muted mb-1">Port</div>
          <div class="d-flex align-items-center gap-2">
            <code class="bg-light px-3 py-2 rounded" style="font-size: 0.9rem;">{{ credential.port }}</code>
            <button class="btn btn-sm btn-ghost btn-icon" onclick="copyToClipboard('{{ credential.port }}')" title="Copy">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-bolt me-2"></i>Quick Actions
        </h3>
      </div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary" onclick="copyAllCredentials()">
            <i class="fas fa-clipboard-list me-2"></i>Copy All Details
          </button>
          {% if credential.credential_type == 'server' %}
          <button class="btn btn-outline-secondary" onclick="generateSSHCommand()">
            <i class="fas fa-terminal me-2"></i>Copy SSH Command
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="col-6 col-md-12" style="padding: 0.75rem;">
    <!-- Credential Info -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-info-circle me-2"></i>Information
        </h3>
      </div>
      <div class="card-body">
        {% if credential.provider %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Provider</div>
          <div class="fw-medium">{{ credential.provider }}</div>
        </div>
        {% endif %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Type</div>
          <div>
            <span class="badge badge-secondary">{{ credential.get_credential_type_display }}</span>
          </div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Expiry Date</div>
          <div class="text-secondary">
            {% if credential.expiry_date %}
            <span class="{% if credential.is_expired %}text-danger{% elif credential.is_expiring_soon %}text-warning{% endif %}">
              <i class="fas fa-calendar me-1"></i>{{ credential.expiry_date|date:"d M Y" }}
              {% if credential.is_expired %}<span class="ms-2 text-danger">(Expired)</span>{% endif %}
              {% if credential.is_expiring_soon %}<span class="ms-2 text-warning">(Expiring Soon)</span>{% endif %}
            </span>
            {% else %}
            <i class="fas fa-infinity me-1"></i>No Expiry
            {% endif %}
          </div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Created</div>
          <div class="text-secondary">{{ credential.created_at|date:"d M Y" }}</div>
        </div>
        <div>
          <div class="text-sm text-muted mb-1">Last Updated</div>
          <div class="text-secondary">{{ credential.updated_at|date:"d M Y" }}</div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    {% if credential.notes %}
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-sticky-note me-2"></i>Notes
        </h3>
      </div>
      <div class="card-body">
        <div class="text-secondary">
          {{ credential.notes|linebreaks }}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Toast notification -->
<div id="toast" style="position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 12px 24px; border-radius: 8px; display: none; z-index: 1000;">
  <i class="fas fa-check-circle me-2"></i>
  <span id="toastMessage">Copied to clipboard!</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const actualPassword = '{{ credential.password|escapejs }}';
  let passwordVisible = false;

  function togglePasswordVisibility() {
    const display = document.getElementById('passwordDisplay');
    const icon = document.getElementById('toggleIcon');
    passwordVisible = !passwordVisible;

    if (passwordVisible) {
      display.textContent = actualPassword;
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      display.textContent = '••••••••••••••••';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    showToast('Copied to clipboard!');
  }

  function copyPassword() {
    navigator.clipboard.writeText(actualPassword);
    showToast('Password copied to clipboard!');
  }

  function copyAllCredentials() {
    const details = `{% if credential.url %}URL: {{ credential.url }}\n{% endif %}{% if credential.username %}Username: {{ credential.username }}\n{% endif %}Password: ${actualPassword}{% if credential.port %}\nPort: {{ credential.port }}{% endif %}`;
    navigator.clipboard.writeText(details);
    showToast('All credentials copied!');
  }

  {% if credential.credential_type == 'server' %}
  function generateSSHCommand() {
    const command = 'ssh {{ credential.username }}@{{ credential.url|cut:"ssh://" }}{% if credential.port %} -p {{ credential.port }}{% endif %}';
    navigator.clipboard.writeText(command);
    showToast('SSH command copied!');
  }
  {% endif %}

  function showToast(message) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 2000);
  }
</script>
{% endblock %}
