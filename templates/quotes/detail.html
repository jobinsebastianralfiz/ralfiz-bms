{% extends 'base.html' %}
{% load static %}

{% block title %}{{ quote.quote_number }} - Ralfiz BMS{% endblock %}

{% block extra_css %}
<style>
  .activity-timeline {
    padding: 1rem;
  }
  .activity-item {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
  }
  .activity-item:last-child {
    border-bottom: none;
  }
  .activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
  }
  .activity-icon.success {
    background: var(--success-light, #dcfce7);
    color: var(--success);
  }
  .activity-icon.info {
    background: var(--info-light, #e0f2fe);
    color: var(--info);
  }
  .activity-icon.primary {
    background: var(--primary-light, #dbeafe);
    color: var(--primary);
  }
  .activity-content {
    flex: 1;
  }
  .avatar-xl {
    width: 64px;
    height: 64px;
    font-size: 1.5rem;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard' %}" class="breadcrumb-item">Dashboard</a>
<span class="breadcrumb-separator">/</span>
<a href="{% url 'quote_list' %}" class="breadcrumb-item">Quotes</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">{{ quote.quote_number }}</span>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="d-flex align-items-center gap-4">
    <div class="avatar avatar-xl" style="background: var(--primary-light, #dbeafe); color: var(--primary);">
      <i class="fas fa-file-alt"></i>
    </div>
    <div>
      <div class="d-flex align-items-center gap-3 mb-2">
        <h1 class="page-title mb-0">Quote #{{ quote.quote_number }}</h1>
        <span class="status-badge {{ quote.status }}">{{ quote.get_status_display }}</span>
      </div>
      <p class="page-subtitle mb-0">
        <a href="{% url 'client_detail' quote.client.pk %}" class="text-primary">
          <i class="fas fa-building me-1"></i>{{ quote.client.name }}
        </a>
        <span class="mx-2">|</span>
        <i class="fas fa-calendar me-1"></i>Created {{ quote.issue_date|date:"d M Y" }}
      </p>
    </div>
  </div>
  <div class="page-actions">
    <a href="{% url 'quote_pdf' quote.pk %}" class="btn btn-outline-secondary" target="_blank">
      <i class="fas fa-file-pdf"></i>
      View PDF
    </a>
    <a href="{% url 'quote_pdf' quote.pk %}?download=1" class="btn btn-outline-secondary">
      <i class="fas fa-download"></i>
      Download PDF
    </a>
    <a href="{% url 'quote_pdf' quote.pk %}?gst=1" class="btn btn-outline-secondary" target="_blank">
      <i class="fas fa-file-pdf"></i>
      PDF with GST
    </a>
    <a href="{% url 'quote_pdf' quote.pk %}?gst=1&download=1" class="btn btn-outline-secondary">
      <i class="fas fa-download"></i>
      Download GST PDF
    </a>
    <a href="{% url 'quote_clone' quote.pk %}" class="btn btn-outline-primary">
      <i class="fas fa-copy"></i>
      Duplicate
    </a>
    <a href="{% url 'quote_convert' quote.pk %}" class="btn btn-success">
      <i class="fas fa-exchange-alt"></i>
      Convert to Invoice
    </a>
    <a href="{% url 'quote_update' quote.pk %}" class="btn btn-primary">
      <i class="fas fa-edit"></i>
      Edit Quote
    </a>
    <a href="{% url 'quote_delete' quote.pk %}" class="btn btn-danger">
      <i class="fas fa-trash-alt"></i>
      Delete
    </a>
  </div>
</div>

<!-- Main Content Grid -->
<div class="row">
  <!-- Left Column - Quote Details -->
  <div class="col-4 col-md-12" style="padding: 0.75rem;">
    <!-- Client Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">Client Information</h3>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Company</div>
          <div class="fw-medium">{{ quote.client.company_name|default:quote.client.name }}</div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Contact Person</div>
          <div>{{ quote.client.name }}</div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Email</div>
          <div>
            <a href="mailto:{{ quote.client.email }}">{{ quote.client.email }}</a>
          </div>
        </div>
        {% if quote.client.gst_number %}
        <div>
          <div class="text-sm text-muted mb-1">GST Number</div>
          <div>{{ quote.client.gst_number }}</div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Quote Details -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">Quote Details</h3>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Quote Number</div>
          <div class="fw-medium">{{ quote.quote_number }}</div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Issue Date</div>
          <div>{{ quote.issue_date|date:"d F Y" }}</div>
        </div>
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Valid Until</div>
          <div>
            {% if quote.valid_until %}
            <span class="{% if quote.is_expired %}text-danger{% else %}text-warning{% endif %}">
              <i class="fas fa-clock me-1"></i>{{ quote.valid_until|date:"d F Y" }}
            </span>
            {% if quote.days_until_expiry is not None %}
            <div class="text-sm text-muted">
              {% if quote.days_until_expiry > 0 %}
              {{ quote.days_until_expiry }} days remaining
              {% elif quote.days_until_expiry == 0 %}
              Expires today
              {% else %}
              Expired
              {% endif %}
            </div>
            {% endif %}
            {% else %}
            <span class="text-muted">Not specified</span>
            {% endif %}
          </div>
        </div>
        {% if quote.project %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Project</div>
          <div><a href="{% url 'project_detail' quote.project.pk %}">{{ quote.project.name }}</a></div>
        </div>
        {% endif %}
        <div>
          <div class="text-sm text-muted mb-1">Status</div>
          <div><span class="status-badge {{ quote.status }}">{{ quote.get_status_display }}</span></div>
        </div>
      </div>
    </div>

    <!-- Activity -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Activity</h3>
      </div>
      <div class="card-body p-0">
        <div class="activity-timeline">
          {% if quote.status == 'accepted' %}
          <div class="activity-item">
            <div class="activity-icon success">
              <i class="fas fa-check"></i>
            </div>
            <div class="activity-content">
              <div class="fw-medium">Quote Accepted</div>
              <div class="text-sm text-muted">Client accepted the quote</div>
              {% if quote.accepted_at %}
              <div class="text-sm text-muted">{{ quote.accepted_at|date:"d M Y, h:i A" }}</div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          {% if quote.status != 'draft' %}
          <div class="activity-item">
            <div class="activity-icon info">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="activity-content">
              <div class="fw-medium">Quote Sent</div>
              <div class="text-sm text-muted">Sent to {{ quote.client.email }}</div>
              {% if quote.sent_at %}
              <div class="text-sm text-muted">{{ quote.sent_at|date:"d M Y, h:i A" }}</div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          <div class="activity-item">
            <div class="activity-icon primary">
              <i class="fas fa-plus"></i>
            </div>
            <div class="activity-content">
              <div class="fw-medium">Quote Created</div>
              {% if quote.created_by %}
              <div class="text-sm text-muted">By {{ quote.created_by.get_full_name|default:quote.created_by.username }}</div>
              {% endif %}
              <div class="text-sm text-muted">{{ quote.created_at|date:"d M Y, h:i A" }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column - Line Items -->
  <div class="col-8 col-md-12" style="padding: 0.75rem;">
    <!-- Quote Title -->
    <div class="card mb-4">
      <div class="card-body">
        <h3 class="mb-2">{{ quote.title }}</h3>
        {% if quote.description %}
        <p class="text-secondary mb-0">{{ quote.description }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Line Items -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">Line Items</h3>
      </div>
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th style="width: 50%;">Description</th>
              <th class="text-center">Qty</th>
              <th class="text-end">Unit Price</th>
              <th class="text-end">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for item in quote.items.all %}
            <tr>
              <td>
                <div class="fw-medium">{{ item.description }}</div>
                {% if item.details %}
                <div class="text-sm text-muted">{{ item.details }}</div>
                {% endif %}
              </td>
              <td class="text-center">{{ item.quantity|floatformat:0 }}</td>
              <td class="text-end">&#8377;{{ item.unit_price|floatformat:2 }}</td>
              <td class="text-end fw-medium">&#8377;{{ item.amount|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center py-4 text-muted">No line items</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Totals -->
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            {% if quote.notes %}
            <div class="text-sm text-muted mb-2">Notes</div>
            <div class="text-secondary text-sm">
              {{ quote.notes|linebreaks }}
            </div>
            {% endif %}
            {% if quote.terms %}
            <div class="text-sm text-muted mb-2 {% if quote.notes %}mt-3{% endif %}">Terms & Conditions</div>
            <div class="text-secondary text-sm">
              {{ quote.terms|linebreaks }}
            </div>
            {% endif %}
          </div>
          <div class="col-6">
            <div class="totals-table" style="margin-left: auto; width: 280px;">
              <div class="d-flex justify-content-between py-2">
                <span class="text-muted">Subtotal</span>
                <span class="fw-medium">&#8377;{{ quote.subtotal|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between py-2">
                <span class="text-muted">Discount</span>
                <span>{% if quote.discount %}-{% endif %}&#8377;{{ quote.discount|default:0|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between py-2" style="border-bottom: 1px solid var(--border-color);">
                <span class="text-muted">Tax ({{ quote.tax_rate|default:0 }}%)</span>
                <span>&#8377;{{ quote.tax_amount|default:0|floatformat:2 }}</span>
              </div>
              <div class="d-flex justify-content-between py-3">
                <span class="fw-bold text-lg">Total</span>
                <span class="fw-bold text-lg text-primary">&#8377;{{ quote.total_amount|floatformat:2 }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

