{% extends 'base.html' %}
{% load static %}

{% block title %}{{ client.name }} - Ralfiz BMS{% endblock %}

{% block extra_css %}
<style>
  .tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0;
  }

  .tab-item {
    padding: 0.75rem 1.25rem;
    border: none;
    background: none;
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
  }

  .tab-item:hover {
    color: var(--primary);
    background: var(--primary-bg);
  }

  .tab-item.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: transparent;
  }

  .tab-content.d-none {
    display: none;
  }

  .avatar-xl {
    width: 72px;
    height: 72px;
    font-size: 1.5rem;
  }

  .priority-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .priority-badge.high {
    background: #fef2f2;
    color: #dc2626;
  }

  .priority-badge.medium {
    background: #fffbeb;
    color: #d97706;
  }

  .priority-badge.low {
    background: #f0fdf4;
    color: #16a34a;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard' %}" class="breadcrumb-item">Dashboard</a>
<span class="breadcrumb-separator">/</span>
<a href="{% url 'client_list' %}" class="breadcrumb-item">Clients</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">{{ client.name }}</span>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <div class="d-flex align-items-center gap-4">
    <div class="avatar avatar-xl">{{ client.name|slice:":2"|upper }}</div>
    <div>
      <div class="d-flex align-items-center gap-3 mb-2">
        <h1 class="page-title mb-0">{{ client.name }}</h1>
        <span class="priority-badge {{ client.priority }}">{{ client.get_priority_display }} Priority</span>
        {% if client.is_active %}
        <span class="badge badge-success">Active</span>
        {% else %}
        <span class="badge badge-secondary">Inactive</span>
        {% endif %}
      </div>
      <p class="page-subtitle mb-0">
        {% if client.address %}
        <i class="fas fa-map-marker-alt me-2"></i>{{ client.address|truncatewords:5 }}
        <span class="mx-2">|</span>
        {% endif %}
        <i class="fas fa-calendar me-2"></i>Client since {{ client.created_at|date:"M Y" }}
      </p>
    </div>
  </div>
  <div class="page-actions">
    <a href="{% url 'project_create' %}?client={{ client.pk }}" class="btn btn-outline-primary">
      <i class="fas fa-folder-plus"></i>
      New Project
    </a>
    <a href="{% url 'quote_create' %}?client={{ client.pk }}" class="btn btn-outline-primary">
      <i class="fas fa-file-alt"></i>
      Create Quote
    </a>
    <a href="{% url 'client_update' client.pk %}" class="btn btn-primary">
      <i class="fas fa-edit"></i>
      Edit Client
    </a>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon primary">
          <i class="fas fa-folder-open"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ projects.count }}</div>
      <div class="stat-card-label">Total Projects</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon success">
          <i class="fas fa-rupee-sign"></i>
        </div>
      </div>
      <div class="stat-card-value">&#8377;{{ total_revenue|floatformat:0|default:"0" }}</div>
      <div class="stat-card-label">Total Revenue</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon warning">
          <i class="fas fa-file-invoice"></i>
        </div>
      </div>
      <div class="stat-card-value">&#8377;{{ pending_amount|floatformat:0|default:"0" }}</div>
      <div class="stat-card-label">Pending Amount</div>
    </div>
  </div>
  <div class="col-3 col-md-6 col-sm-12" style="padding: 0.75rem;">
    <div class="card stat-card">
      <div class="stat-card-header">
        <div class="stat-card-icon info">
          <i class="fas fa-key"></i>
        </div>
      </div>
      <div class="stat-card-value">{{ credentials_count|default:"0" }}</div>
      <div class="stat-card-label">Credentials</div>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="row">
  <!-- Left Column - Client Details -->
  <div class="col-4 col-md-12" style="padding: 0.75rem;">
    <!-- Contact Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="card-title">Contact Information</h3>
      </div>
      <div class="card-body">
        {% if client.company_name %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Contact Person</div>
          <div class="fw-medium">{{ client.name }}</div>
        </div>
        {% endif %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Email</div>
          <div>
            <a href="mailto:{{ client.email }}" class="d-flex align-items-center gap-2">
              <i class="fas fa-envelope"></i>
              {{ client.email }}
            </a>
          </div>
        </div>
        {% if client.phone %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Phone</div>
          <div>
            <a href="tel:{{ client.phone }}" class="d-flex align-items-center gap-2">
              <i class="fas fa-phone"></i>
              {{ client.phone }}
            </a>
          </div>
        </div>
        {% endif %}
        {% if client.whatsapp %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">WhatsApp</div>
          <div>
            <a href="https://wa.me/{{ client.whatsapp }}" target="_blank" class="d-flex align-items-center gap-2">
              <i class="fab fa-whatsapp"></i>
              {{ client.whatsapp }}
            </a>
          </div>
        </div>
        {% endif %}
        {% if client.address %}
        <div>
          <div class="text-sm text-muted mb-1">Address</div>
          <div class="text-secondary">
            <i class="fas fa-map-marker-alt me-2"></i>
            {{ client.address|linebreaksbr }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Business Information -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Business Information</h3>
      </div>
      <div class="card-body">
        {% if client.company_name %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">Company Name</div>
          <div class="fw-medium">{{ client.company_name }}</div>
        </div>
        {% endif %}
        {% if client.gst_number %}
        <div class="mb-3">
          <div class="text-sm text-muted mb-1">GST Number</div>
          <div class="fw-medium">{{ client.gst_number }}</div>
        </div>
        {% endif %}
        {% if client.notes %}
        <div>
          <div class="text-sm text-muted mb-1">Notes</div>
          <div class="text-secondary">
            {{ client.notes|linebreaks }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column - Projects, Invoices, Quotes, Payments -->
  <div class="col-8 col-md-12" style="padding: 0.75rem;">
    <!-- Tabs -->
    <div class="card">
      <div class="card-header" style="padding-bottom: 0; border-bottom: none;">
        <div class="tabs">
          <button class="tab-item active" data-tab="projectsTab" onclick="switchTab('projectsTab')">
            <i class="fas fa-folder-open me-2"></i>Projects
          </button>
          <button class="tab-item" data-tab="invoicesTab" onclick="switchTab('invoicesTab')">
            <i class="fas fa-file-invoice-dollar me-2"></i>Invoices
          </button>
          <button class="tab-item" data-tab="quotesTab" onclick="switchTab('quotesTab')">
            <i class="fas fa-file-alt me-2"></i>Quotes
          </button>
          <button class="tab-item" data-tab="paymentsTab" onclick="switchTab('paymentsTab')">
            <i class="fas fa-credit-card me-2"></i>Payments
          </button>
        </div>
      </div>

      <!-- Projects Tab -->
      <div class="tab-content" id="projectsTab">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Project</th>
                <th>Type</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Deadline</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for project in projects %}
              <tr>
                <td>
                  <a href="{% url 'project_detail' project.pk %}" class="fw-medium">{{ project.name }}</a>
                  {% if project.tech_stack %}
                  <div class="text-sm text-muted">{{ project.tech_stack|truncatewords:5 }}</div>
                  {% endif %}
                </td>
                <td><span class="badge badge-info">{{ project.get_project_type_display }}</span></td>
                <td><span class="status-badge {{ project.status }}">{{ project.get_status_display }}</span></td>
                <td class="fw-medium">&#8377;{{ project.estimated_budget|floatformat:0|default:"-" }}</td>
                <td>{{ project.deadline|date:"d M Y"|default:"-" }}</td>
                <td>
                  <a href="{% url 'project_detail' project.pk %}" class="btn btn-sm btn-ghost btn-icon">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">No projects yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Invoices Tab -->
      <div class="tab-content d-none" id="invoicesTab">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Project</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
              <tr>
                <td><a href="{% url 'invoice_detail' invoice.pk %}" class="fw-medium">{{ invoice.invoice_number }}</a></td>
                <td>{{ invoice.project.name|default:"-" }}</td>
                <td class="fw-medium">&#8377;{{ invoice.total_amount|floatformat:0 }}</td>
                <td>{{ invoice.due_date|date:"d M Y"|default:"-" }}</td>
                <td><span class="status-badge {{ invoice.status }}">{{ invoice.get_status_display }}</span></td>
                <td>
                  <a href="{% url 'invoice_detail' invoice.pk %}" class="btn btn-sm btn-ghost btn-icon">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">No invoices yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Quotes Tab -->
      <div class="tab-content d-none" id="quotesTab">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Quote #</th>
                <th>Title</th>
                <th>Amount</th>
                <th>Valid Until</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for quote in quotes %}
              <tr>
                <td><a href="{% url 'quote_detail' quote.pk %}" class="fw-medium">{{ quote.quote_number }}</a></td>
                <td>{{ quote.title }}</td>
                <td class="fw-medium">&#8377;{{ quote.total_amount|floatformat:0 }}</td>
                <td>{{ quote.valid_until|date:"d M Y"|default:"-" }}</td>
                <td><span class="status-badge {{ quote.status }}">{{ quote.get_status_display }}</span></td>
                <td>
                  <a href="{% url 'quote_detail' quote.pk %}" class="btn btn-sm btn-ghost btn-icon">
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">No quotes yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Payments Tab -->
      <div class="tab-content d-none" id="paymentsTab">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Invoice</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Transaction ID</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr>
                <td>{{ payment.payment_date|date:"d M Y" }}</td>
                <td><a href="{% url 'invoice_detail' payment.invoice.pk %}">{{ payment.invoice.invoice_number }}</a></td>
                <td class="fw-medium text-success">&#8377;{{ payment.amount|floatformat:0 }}</td>
                <td><span class="badge badge-info">{{ payment.get_payment_method_display }}</span></td>
                <td class="text-muted">{{ payment.transaction_id|default:"-" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">No payments yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function switchTab(tabId) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('d-none');
  });

  // Remove active class from all tabs
  document.querySelectorAll('.tab-item').forEach(tab => {
    tab.classList.remove('active');
  });

  // Show selected tab content
  document.getElementById(tabId).classList.remove('d-none');

  // Add active class to clicked tab
  document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
}
</script>
{% endblock %}
