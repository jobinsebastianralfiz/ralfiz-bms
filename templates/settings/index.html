{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - Ralfiz BMS{% endblock %}

{% block extra_css %}
<style>
  .settings-nav {
    display: flex;
    flex-direction: column;
  }
  .settings-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    border-left: 3px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
  }
  .settings-nav-item:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
  }
  .settings-nav-item.active {
    background: var(--primary-bg);
    color: var(--primary);
    border-left-color: var(--primary);
  }
  .settings-nav-item i {
    width: 20px;
    text-align: center;
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 26px;
  }
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }
  .toggle-switch input:checked + .toggle-slider {
    background-color: var(--primary);
  }
  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(22px);
  }

  .settings-panel.d-none {
    display: none;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<a href="{% url 'dashboard' %}" class="breadcrumb-item">Dashboard</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-item active">Settings</span>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle mb-0">Manage your company and system settings</p>
  </div>
</div>

<!-- Settings Tabs -->
<div class="row">
  <!-- Settings Navigation -->
  <div class="col-3 col-md-12" style="padding: 0.75rem;">
    <div class="card">
      <div class="card-body p-0">
        <nav class="settings-nav">
          <a class="settings-nav-item active" onclick="switchSettingsTab('company')">
            <i class="fas fa-building"></i>
            <span>Company Info</span>
          </a>
          <a class="settings-nav-item" onclick="switchSettingsTab('bank')">
            <i class="fas fa-university"></i>
            <span>Bank Details</span>
          </a>
          <a class="settings-nav-item" onclick="switchSettingsTab('invoice')">
            <i class="fas fa-file-invoice"></i>
            <span>Invoice Settings</span>
          </a>
          <a class="settings-nav-item" onclick="switchSettingsTab('notifications')">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
          </a>
        </nav>
      </div>
    </div>
  </div>

  <!-- Settings Content -->
  <div class="col-9 col-md-12" style="padding: 0.75rem;">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Company Info -->
      <div class="settings-panel" id="company-panel">
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-building me-2 text-primary"></i>
              Company Information
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Company Name</label>
                  <input type="text" class="form-control" name="company_name" value="{{ company.company_name|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Tagline</label>
                  <input type="text" class="form-control" name="tagline" value="{{ company.tagline|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" name="email" value="{{ company.email|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" name="phone" value="{{ company.phone|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Website</label>
                  <input type="url" class="form-control" name="website" value="{{ company.website|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">GSTIN</label>
                  <input type="text" class="form-control" name="gst_number" value="{{ company.gst_number|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">PAN Number</label>
                  <input type="text" class="form-control" name="pan_number" value="{{ company.pan_number|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">HSN/SAC Code</label>
                  <input type="text" class="form-control" name="hsn_code" value="{{ company.hsn_code|default:'' }}" placeholder="e.g., 998314 for IT services">
                  <div class="form-text">HSN code for goods or SAC code for services</div>
                </div>
              </div>
              <div class="col-12" style="padding: 0.5rem;">
                <div class="form-group mb-0">
                  <label class="form-label">Address</label>
                  <textarea class="form-control" name="address" rows="3">{{ company.address|default:'' }}</textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-image me-2 text-primary"></i>
              Logo & Branding
            </h3>
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-3 col-sm-12" style="padding: 0.5rem;">
                <div class="logo-preview" style="width: 120px; height: 120px; background: var(--primary-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                  {% if company.logo %}
                  <img src="{{ company.logo.url }}" alt="Logo" style="max-width: 100%; max-height: 100%;">
                  {% else %}
                  <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 36px;">
                    R
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-9 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group mb-0">
                  <label class="form-label">Company Logo</label>
                  <input type="file" class="form-control" name="logo" accept="image/*">
                  <div class="form-text">Recommended: 200x200px PNG with transparent background</div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </div>
      </div>

      <!-- Bank Details -->
      <div class="settings-panel d-none" id="bank-panel">
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-university me-2 text-primary"></i>
              Bank Account Details
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Bank Name</label>
                  <input type="text" class="form-control" name="bank_name" value="{{ company.bank_name|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Branch</label>
                  <input type="text" class="form-control" name="bank_branch" value="{{ company.bank_branch|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Account Number</label>
                  <input type="text" class="form-control" name="bank_account_number" value="{{ company.bank_account_number|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">IFSC Code</label>
                  <input type="text" class="form-control" name="bank_ifsc" value="{{ company.bank_ifsc|default:'' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Account Holder Name</label>
                  <input type="text" class="form-control" name="account_holder_name" value="{{ company.account_holder_name|default:company.company_name }}">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-mobile-alt me-2 text-primary"></i>
              UPI Details
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group mb-0">
                  <label class="form-label">UPI ID</label>
                  <input type="text" class="form-control" name="upi_id" value="{{ company.upi_id|default:'' }}">
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </div>
      </div>

      <!-- Invoice Settings -->
      <div class="settings-panel d-none" id="invoice-panel">
        <div class="card mb-4">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-invoice me-2 text-primary"></i>
              Invoice Preferences
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Invoice Prefix</label>
                  <input type="text" class="form-control" name="invoice_prefix" value="{{ company.invoice_prefix|default:'INV' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Quote Prefix</label>
                  <input type="text" class="form-control" name="quote_prefix" value="{{ company.quote_prefix|default:'QT' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Default Payment Terms (Days)</label>
                  <input type="number" class="form-control" name="payment_terms" value="{{ company.payment_terms|default:'15' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Quote Validity (Days)</label>
                  <input type="number" class="form-control" name="quote_validity" value="{{ company.quote_validity|default:'15' }}">
                </div>
              </div>
              <div class="col-6 col-sm-12" style="padding: 0.5rem;">
                <div class="form-group">
                  <label class="form-label">Default Tax Rate (%)</label>
                  <input type="number" class="form-control" name="default_tax_rate" value="{{ company.default_tax_rate|default:'18' }}" step="0.01">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-align-left me-2 text-primary"></i>
              Default Terms & Notes
            </h3>
          </div>
          <div class="card-body">
            <div class="form-group mb-4">
              <label class="form-label">Default Invoice Terms</label>
              <textarea class="form-control" name="invoice_terms" rows="4">{{ company.invoice_terms|default:'' }}</textarea>
            </div>
            <div class="form-group mb-0">
              <label class="form-label">Default Quote Terms</label>
              <textarea class="form-control" name="quote_terms" rows="4">{{ company.quote_terms|default:'' }}</textarea>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="settings-panel d-none" id="notifications-panel">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-bell me-2 text-primary"></i>
              Notification Preferences
            </h3>
          </div>
          <div class="card-body">
            <div class="settings-item d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-medium">Invoice Payment Received</div>
                <div class="text-sm text-muted">Get notified when a payment is recorded</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="notify_payment" {% if company.notify_payment %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-item d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-medium">Overdue Invoice Reminders</div>
                <div class="text-sm text-muted">Daily reminder for overdue invoices</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="notify_overdue" {% if company.notify_overdue %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-item d-flex justify-content-between align-items-center py-3 border-bottom">
              <div>
                <div class="fw-medium">Credential Expiry Alerts</div>
                <div class="text-sm text-muted">Get notified before credentials expire</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="notify_credential_expiry" {% if company.notify_credential_expiry %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-item d-flex justify-content-between align-items-center py-3">
              <div>
                <div class="fw-medium">Quote Accepted</div>
                <div class="text-sm text-muted">Notify when a client accepts a quote</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="notify_quote_accepted" {% if company.notify_quote_accepted %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function switchSettingsTab(tabName) {
    // Update nav
    document.querySelectorAll('.settings-nav-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[onclick="switchSettingsTab('${tabName}')"]`).classList.add('active');

    // Update panels
    document.querySelectorAll('.settings-panel').forEach(panel => {
      panel.classList.add('d-none');
    });
    document.getElementById(tabName + '-panel').classList.remove('d-none');
  }
</script>
{% endblock %}
